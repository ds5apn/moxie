<?xml version="1.0" encoding="UTF-8"?>
<project name="maxilla" default="main" basedir=".">

	<!-- These are the default Maxilla locations -->
	<property name="maxilla.bin" value="${basedir}/build" />
	<property name="maxilla.bin.classes" value="${maxilla.bin}/classes" />

	<!--
	Declare the Maxilla tasks and Compile all of Maxilla
	-->
	<target name="bootstrap">
		<!-- Clean -->
		<delete dir="${maxilla.bin}" />
		<mkdir dir="${maxilla.bin}" />
		<mkdir dir="${maxilla.bin.classes}" />

		<!-- Bootstrap compile MaxSetup task and core objects -->
		<javac debug="true" destdir="${maxilla.bin.classes}" includeantruntime="true" failonerror="false" verbose="no">
			<src path="${basedir}/src/main/core" />
		</javac>

		<!-- Declare MaxSetup and download dependencies -->
		<taskdef classname="com.maxtk.ant.MaxSetup" name="maxsetup" classpath="${maxilla.bin.classes}" loaderref="maxilla.bootstrap" />
		<maxsetup verbose="false" />

		<!-- Compile all of Maxilla with maxjavac and retrieved dependencies -->
		<taskdef classname="com.maxtk.ant.MaxJavac" name="maxjavac" classpath="${maxilla.bin.classes}" loaderref="maxilla.bootstrap" />
		<maxjavac debug="true" includeantruntime="true" failonerror="true" copyResources="true" />
		
	</target>


	<!--
	Build the Maxilla release
	-->
	<target name="main">

		<!-- Bootstrap Maxilla in a separate task -->
		<antcall target="bootstrap" inheritall="false" inheritrefs="false" />

		<!-- 
		Manually construct the Maxilla bootstrap classpath and define the tasks 
		because we need to load the tasks using the same classloader in order
		to share objects.  This is handled automatically in production Maxilla jars.
		-->
		<path id="bootstrap.path">
			<pathelement path="${maxilla.bin.classes}" />
		</path>

		<!-- Core -->
		<taskdef classname="com.maxtk.ant.MaxSetup" name="maxsetup" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxJavac" name="maxjavac" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxClean" name="maxclean" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />

		<!-- Pro -->
		<taskdef classname="com.maxtk.ant.MaxJar" name="maxjar" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxZip" name="maxzip" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		
		<!-- All -->
		<taskdef classname="com.maxtk.ant.MaxExtract" name="maxextract" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxCommitId" name="maxcommitid" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxGhPages" name="maxghpages" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />
		<taskdef classname="com.maxtk.ant.MaxDoc" name="maxdoc" classpathref="bootstrap.path" loaderref="maxilla.bootstrap" />

		<!-- Run Maxilla setup -->
		<maxsetup />
		
		<maxcommitid verbose="true" />
		
		<!-- Delete the target folder -->
		<delete dir="${max.targetFolder}" />
		
		<!-- Maxilla-Core -->
		<maxjar destfile="${max.targetFolder}/maxilla-core.jar">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.fusesource." />
				<exclude name="org.w3c." />
			</classfilter>
			<class name="com.maxtk.ant.MaxSetup" />
			<class name="com.maxtk.ant.MaxClean" />
			<class name="com.maxtk.ant.MaxJavac" />
						
			<class name="com.maxtk.opt.JansiConsole" />
			
			<resource file="${basedir}/src/main/resources/maxilla.xml" />
			<resource file="${basedir}/src/main/config/core/tasks.properties" />
		</maxjar>
		
		
		<!-- Maxilla-Pro -->
		<maxjar destfile="${max.targetFolder}/maxilla-pro.jar">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.fusesource." />
				<exclude name="org.w3c." />
			</classfilter>
				
			<class name="com.maxtk.ant.MaxSetup" />
			<class name="com.maxtk.ant.MaxClean" />
			<class name="com.maxtk.ant.MaxJavac" />

			<class name="com.maxtk.ant.MaxJar" />
			<class name="com.maxtk.ant.MaxZip" />

			<class name="com.maxtk.opt.JansiConsole" />
			
			<resource file="${basedir}/src/main/resources/maxilla.xml" />
			<resource file="${basedir}/src/main/config/pro/tasks.properties" />
		</maxjar>

		
		<!-- Maxilla-All -->
		<maxjar destfile="${max.targetFolder}/maxilla-all.jar" includeresources="true">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.fusesource." />
				<exclude name="org.tautua." />
				<exclude name="org.w3c." />				
			</classfilter>
			<class name="com.maxtk.ant.MaxSetup" />
			<class name="com.maxtk.ant.MaxClean" />
			<class name="com.maxtk.ant.MaxJavac" />
				
			<class name="com.maxtk.ant.MaxJar" />
			<class name="com.maxtk.ant.MaxZip" />
				
			<class name="com.maxtk.ant.MaxKeys" />
			<class name="com.maxtk.ant.MaxExtract" />
			<class name="com.maxtk.ant.MaxCommitId" />
			<class name="com.maxtk.ant.MaxGhPages" />				
			<class name="com.maxtk.ant.MaxDoc" />
			
			<class name="com.maxtk.opt.JansiConsole" />
			
			<resource file="${basedir}/src/main/resources/maxilla.xml" />
			<resource file="${basedir}/src/main/config/all/tasks.properties" />

		</maxjar>

		<!-- Maxml -->
		<maxjar destfile="${max.targetFolder}/maxml.jar">
			<class name="com.maxtk.maxml.Maxml" />
		</maxjar>

		<jar destfile="${max.targetFolder}/maxml-sources.jar">
			<fileset dir="${basedir}/src/main/core/com/maxtk/maxml" />
		</jar>

		<!-- Build the site documentation -->
		<maxdoc verbose="true" googlePlusOne="true" injectPrettify="true">
			<structure>
				<page name="overview" src="index.mkd" />
				<menu name="tasks">
					<page name="MaxSetup" src="maxsetup.mkd" />
					<page name="MaxExtract" src="maxextract.mkd" />
					<divider />
					<page name="MaxCommitId" src="maxcommitid.mkd" />
					<page name="MaxGhPages" src="maxghpages.mkd" />					
					<page name="MaxJar" src="maxjar.mkd" />
					<divider />
					<page name="MaxDoc" src="maxdoc.mkd" />
				</menu>
				<page name="maxml" src="maxml.mkd" sidebar="true" />
				<page name="design" src="design.mkd" />
				<page name="releases" src="releases.mkd" />
				<menu name="download">
					<link name="maxilla-core" src="maxilla-core.jar" />
					<link name="maxilla-pro" src="maxilla-pro.jar" />
					<link name="maxilla-all" src="maxilla-all.jar" />
					<divider />
					<link name="maxml" src="maxml.jar" />
					<link name="maxml-sources" src="maxml-sources.jar" />
				</menu>
				<link name="GitHub" src="http://github.com/gitblit/maxilla" />
				<divider />
			</structure>
			<substitute token="%VERSION%" value="${max-version}" />
			<nomarkdown startToken="%BEGINMAXML%" endToken="%ENDMAXML%" prettify="true" lang="lang-yaml" />
			<nomarkdown startToken="%BEGINXML%" endToken="%ENDXML%" prettify="true" lang="lang-xml" />
			<regex searchPattern="\b(issue)(\s*[#]?|-){0,1}(\d+)\b" replacePattern="&lt;a href='http://code.google.com/p/gitblit/issues/detail?id=$3'&gt;issue $3&lt;/a&gt;" />
			<resource>
				<fileset dir="${max.targetFolder}/" includes="*.jar" />
			</resource>
		</maxdoc>
	</target>

	<!--
	Build the Maxilla gh-pages branch
	-->
	<target name="ghpages" depends="main">
		<maxghpages sourceFolder="${max.targetFolder}/site" obliterate="true" />
	</target>
</project>