<?xml version="1.0" encoding="UTF-8"?>
<project default="main" xmlns:mx="antlib:org.moxie">

	<!-- These are the default Moxie locations -->
	<property name="moxie.bin" value="${basedir}/build" />
	<property name="moxie.bin.classes" value="${moxie.bin}/classes" />

	<!--
	Declare the Moxie tasks and Compile all of Moxie
	-->
	<target name="bootstrap">
		<!-- Clean -->
		<delete dir="${moxie.bin}" />
		<mkdir dir="${moxie.bin}" />
		<mkdir dir="${moxie.bin.classes}" />

		<!-- Bootstrap compile MxInit task and core objects -->
		<javac debug="true" destdir="${moxie.bin.classes}" includeantruntime="true" failonerror="false" verbose="no">
			<src path="${basedir}/src/main/core" />
		</javac>
		
		<!-- Copy Moxie resources -->
		<copy todir="${moxie.bin.classes}" overwrite="false">
			<fileset dir="${basedir}/src/main/resources" />
		</copy>

		<!-- Declare mx:init and read configuration -->
		<taskdef classname="org.moxie.ant.MxInit" name="init" classpath="${moxie.bin.classes}" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<mx:init />

		<!-- Compile all of Moxie with mx:javac and retrieved dependencies -->
		<taskdef classname="org.moxie.ant.MxJavac" name="javac" classpath="${moxie.bin.classes}" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<mx:javac />
		
	</target>


	<!--
	Build the Moxie release
	-->
	<target name="main">

		<!-- Bootstrap Moxie in a separate task -->
		<antcall target="bootstrap" inheritall="false" inheritrefs="false" />

		<!-- 
		Manually construct the Moxie bootstrap classpath and define the tasks 
		because we need to load the tasks using the same classloader in order
		to share objects.  This is handled automatically in production Moxie jars.
		-->
		<path id="bootstrap.path">
			<pathelement path="${moxie.bin.classes}" />
		</path>

		<!-- Core -->
		<taskdef classname="org.moxie.ant.MxInit" name="init" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxJavac" name="javac" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxClean" name="clean" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxInstall" name="install" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxReport" name="report" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.antcontrib.IfTask" name="if" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />

		<!-- Pro -->
		<taskdef classname="org.moxie.ant.MxJar" name="jar" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxZip" name="zip" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		
		<!-- All -->
		<taskdef classname="org.moxie.ant.MxExtract" name="extract" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxGitId" name="gitid" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxGhPages" name="ghpages" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />
		<taskdef classname="org.moxie.ant.MxDoc" name="doc" classpathref="bootstrap.path" loaderref="moxie.bootstrap" uri="antlib:org.moxie" />

		<!-- Prepare the project -->
		<mx:init />

		<mx:gitid verbose="true" />
				
		<!-- Delete the target folder -->
		<delete dir="${mxp.targetFolder}" />
		
		<mx:report />

		<!-- Moxie-Core -->
		<mx:jar classifier="core">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.w3c." />
			</classfilter>
			<class name="org.moxie.ant.MxInit" />
			<class name="org.moxie.ant.MxClean" />
			<class name="org.moxie.ant.MxJavac" />
			<class name="org.moxie.ant.MxInstall" />
			<class name="org.moxie.ant.MxReport" />
			<class name="org.moxie.antcontrib.IfTask" />
			<class name="org.moxie.cobertura.ReportTask" />
			
			<resource>
				<fileset dir="${basedir}/src/main/resources" />
			</resource>
			<resource file="${basedir}/src/main/config/core/tasks.properties" />
		</mx:jar>
		
		
		<!-- Moxie-Pro -->
		<mx:jar classifier="pro">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.w3c." />
			</classfilter>
				
			<class name="org.moxie.ant.MxInit" />
			<class name="org.moxie.ant.MxClean" />
			<class name="org.moxie.ant.MxJavac" />
			<class name="org.moxie.ant.MxInstall" />
			<class name="org.moxie.ant.MxReport" />
			<class name="org.moxie.antcontrib.IfTask" />
			<class name="org.moxie.cobertura.ReportTask" />
			
			<class name="org.moxie.ant.MxJar" />
			<class name="org.moxie.ant.MxZip" />

			<resource>
				<fileset dir="${basedir}/src/main/resources" />
			</resource>
			<resource file="${basedir}/src/main/config/pro/tasks.properties" />
		</mx:jar>

		
		<!-- Moxie-All -->
		<mx:jar classifier="all" includeResources="true" packageSources="true">
			<classfilter>
				<exclude name="org.apache." />
				<exclude name="org.eclipse." />
				<exclude name="org.tautua." />
				<exclude name="org.w3c." />				
			</classfilter>
			<class name="org.moxie.ant.MxInit" />
			<class name="org.moxie.ant.MxClean" />
			<class name="org.moxie.ant.MxJavac" />
			<class name="org.moxie.ant.MxInstall" />
			<class name="org.moxie.ant.MxReport" />
			<class name="org.moxie.antcontrib.IfTask" />
			<class name="org.moxie.cobertura.ReportTask" />
				
			<class name="org.moxie.ant.MxJar" />
			<class name="org.moxie.ant.MxZip" />
				
			<class name="org.moxie.ant.MxKeys" />
			<class name="org.moxie.ant.MxExtract" />
			<class name="org.moxie.ant.MxGitId" />
			<class name="org.moxie.ant.MxGhPages" />				
			<class name="org.moxie.ant.MxDoc" />
			
			<resource>
				<fileset dir="${basedir}/src/main/resources" />
			</resource>
			<resource file="${basedir}/src/main/config/all/tasks.properties" />

		</mx:jar>

		<!-- Maxml -->
		<mx:jar destfile="${mxp.targetFolder}/maxml-${project.version}.jar" packageSources="true">
			<class name="org.moxie.maxml.Maxml" />
		</mx:jar>

		<!-- Install the build to our Moxie cache -->
		<mx:install />

		<!-- Build the site documentation -->
		<mx:doc googlePlusOne="true" injectPrettify="true">
			<structure>
				<page name="overview" src="index.mkd" />
				<menu name="tasks">
					<page name="mx:Init" src="mxinit.mkd" />
					<page name="mx:Jar" src="mxjar.mkd" />
					<divider />
					<page name="mx:Extract" src="mxextract.mkd" />
					<page name="mx:GitId" src="mxgitid.mkd" />
					<page name="mx:GhPages" src="mxghpages.mkd" />					
					<divider />
					<page name="mx:Doc" src="mxdoc.mkd" />
				</menu>
				<page name="maxml" src="maxml.mkd" sidebar="true" />
				<page name="design" src="design.mkd" />
				<page name="releases" src="releases.mkd" />
				<menu name="download">
					<link name="moxie-core" src="moxie-core.jar" />
					<link name="moxie-pro" src="moxie-pro.jar" />
					<link name="moxie-all" src="moxie-all.jar" />
					<divider />
					<link name="maxml" src="maxml.jar" />
					<link name="maxml-sources" src="maxml-sources.jar" />
				</menu>
				<link name="GitHub" src="http://github.com/gitblit/moxie" />
				<divider />
			</structure>
			<substitute token="%VERSION%" value="${mxp.version}" />
			<nomarkdown startToken="%BEGINMAXML%" endToken="%ENDMAXML%" prettify="true" lang="lang-yaml" />
			<nomarkdown startToken="%BEGINXML%" endToken="%ENDXML%" prettify="true" lang="lang-xml" />
			<regex searchPattern="\b(issue)(\s*[#]?|-){0,1}(\d+)\b" replacePattern="&lt;a href='http://code.google.com/p/gitblit/issues/detail?id=$3'&gt;issue $3&lt;/a&gt;" />
			<resource>
				<fileset dir="${mxp.targetFolder}/" includes="*.jar" />
			</resource>
			<logo file="${basedir}/src/main/resources/moxie.png" />
		</mx:doc>
	</target>

	<!--
	Build the Moxie gh-pages branch
	-->
	<target name="ghpages" depends="main">
		<mx:ghpages sourceFolder="${mxp.targetFolder}/site" obliterate="true" />
	</target>
</project>